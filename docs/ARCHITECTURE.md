# BigScreen Pro - 系统架构设计

## 1. 架构概述

### 1.1 设计原则

- **模块化设计**: 高内聚、低耦合，便于扩展和维护
- **分层架构**: 清晰的职责分离，每层专注特定功能
- **微服务思想**: 服务独立部署，灵活扩展
- **前后端分离**: 独立开发、部署、迭代

### 1.2 架构全景

```
┌─────────────────────────────────────────────────────────────────┐
│                         接入层 (Access Layer)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Web 端    │  │   移动端    │  │  大屏展示   │              │
│  │  (Vue3)     │  │   (H5)      │  │  (Viewer)   │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │
          └────────────────┴────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────┐
│                      网关层 (Gateway Layer)                   │
│  ┌────────────────────────┴─────────────────────────────┐     │
│  │              Nginx / API Gateway                     │     │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐         │     │
│  │  │ 负载均衡  │  │ SSL/TLS  │  │ 静态资源  │         │     │
│  │  │ 限流熔断  │  │ 安全防护  │  │ 缓存加速  │         │     │
│  │  └──────────┘  └──────────┘  └──────────┘         │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────┐
│                      服务层 (Service Layer)                   │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐       │
│  │   API 服务    │ │   实时服务    │ │   文件服务    │       │
│  │   (REST)      │ │  (WebSocket)  │ │    (OSS)      │       │
│  └───────┬───────┘ └───────┬───────┘ └───────┬───────┘       │
│          │                 │                 │               │
│  ┌───────┴───────┐ ┌───────┴───────┐ ┌───────┴───────┐       │
│  │   业务服务    │ │   搜索服务    │ │   定时任务    │       │
│  │  (Services)   │ │Elasticsearch│ │    (Cron)     │       │
│  └───────────────┘ └───────────────┘ └───────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────┐
│                      数据层 (Data Layer)                      │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐       │
│  │  PostgreSQL   │ │    Redis      │ │ Elasticsearch │       │
│  │   (主数据库)   │ │   (缓存)      │ │   (搜索引擎)  │       │
│  └───────────────┘ └───────────────┘ └───────────────┘       │
│                                                               │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐       │
│  │    MinIO      │ │  ClickHouse   │ │     Kafka     │       │
│  │   (对象存储)   │ │  (分析数据库) │ │   (消息队列)  │       │
│  └───────────────┘ └───────────────┘ └───────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 2. 分层架构详解

### 2.1 接入层 (Access Layer)

负责用户交互和界面展示。

#### 2.1.1 Web 端 (Editor + Admin)

```
┌─────────────────────────────────────────┐
│              Web 前端                   │
├─────────────────────────────────────────┤
│  ┌───────────┐ ┌───────────┐ ┌────────┐ │
│  │  Editor   │ │  Admin   │ │ Viewer│ │
│  │  编辑器   │ │ 管理后台  │ │ 展示器│ │
│  └─────┬─────┘ └─────┬─────┘ └───┬───┘ │
│        │             │           │     │
│  ┌─────┴─────────────┴───────────┴────┐│
│  │           共享组件层                ││
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ││
│  │  │Charts  │ │UI Comp │ │Utils   │ ││
│  │  └────────┘ └────────┘ └────────┘ ││
│  └────────────────────────────────────┘│
└─────────────────────────────────────────┘
```

**技术实现**:
- Vue 3 + TypeScript + Vite
- Pinia 状态管理
- Vue Router 路由
- Naive UI 组件库
- ECharts 图表

#### 2.1.2 移动端 (H5)

简化的大屏展示版本，支持移动设备查看。

#### 2.1.3 大屏展示 (Viewer)

独立的大屏展示应用，用于最终展示场景。

### 2.2 网关层 (Gateway Layer)

统一入口，负责请求路由、负载均衡、安全防护。

```
┌─────────────────────────────────────────┐
│              API Gateway                │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐  │
│  │         请求处理流程               │  │
│  │                                   │  │
│  │  ① 接收请求 → ② 限流检查         │  │
│  │       ↓                           │  │
│  │  ③ 认证鉴权 → ④ 路由转发         │  │
│  │       ↓                           │  │
│  │  ⑤ 负载均衡 → ⑥ 服务调用         │  │
│  │       ↓                           │  │
│  │  ⑦ 响应处理 → ⑧ 返回客户端       │  │
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                          │
│  ┌────────┐ ┌────────┐ ┌────────┐        │
│  │ 限流器  │ │ 熔断器  │ │ 缓存器  │        │
│  │(Rate)  │ │(Circuit)│ │(Cache) │        │
│  └────────┘ └────────┘ └────────┘        │
└─────────────────────────────────────────┘
```

**功能模块**:
- 负载均衡 (Load Balancing)
- 限流熔断 (Rate Limiting & Circuit Breaking)
- 认证鉴权 (Authentication & Authorization)
- SSL/TLS 终止
- 缓存加速
- 日志记录

### 2.3 服务层 (Service Layer)

业务逻辑处理层，按业务领域划分微服务。

#### 2.3.1 服务划分

```
┌─────────────────────────────────────────┐
│            业务服务架构                   │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────┐    ┌─────────────┐    │
│  │   核心服务   │    │   支撑服务   │    │
│  │  (Core)     │    │ (Support)   │    │
│  │             │    │             │    │
│  │ • 大屏服务  │    │ • 文件服务  │    │
│  │ • 组件服务  │    │ • 搜索服务  │    │
│  │ • 数据源  │    │ • 消息服务  │    │
│  │ • 用户服务  │    │ • 定时任务  │    │
│  └─────────────┘    └─────────────┘    │
│                                         │
│  ┌─────────────┐    ┌─────────────┐    │
│  │   接口服务   │    │   实时服务   │    │
│  │    (API)    │    │  (Realtime) │    │
│  │             │    │             │    │
│  │ • REST API │    │ • WebSocket │    │
│  │ • GraphQL  │    │ • SSE       │    │
│  │ • gRPC     │    │ • 实时推送   │    │
│  └─────────────┘    └─────────────┘    │
│                                         │
└─────────────────────────────────────────┘
```

#### 2.3.2 核心服务说明

| 服务名 | 职责 | 技术要点 |
|--------|------|----------|
| **大屏服务 (Screen Service)** | 大屏的 CRUD、发布、版本管理 | 版本控制、模板继承 |
| **组件服务 (Component Service)** | 组件注册、分类、版本管理 | 组件市场、动态加载 |
| **数据源服务 (DataSource Service)** | 数据源配置、连接管理 | 连接池、安全存储 |
| **用户服务 (User Service)** | 用户管理、认证授权 | JWT、RBAC、OAuth2 |
| **文件服务 (File Service)** | 文件上传、存储、CDN | MinIO、图片处理 |
| **实时服务 (Realtime Service)** | WebSocket、SSE、实时推送 | Socket.io、事件驱动 |

### 2.4 数据层 (Data Layer)

数据持久化和缓存层。

```
┌─────────────────────────────────────────┐
│              数据架构层                   │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         主数据存储                 │   │
│  │                                 │   │
│  │    ┌───────────────┐           │   │
│  │    │  PostgreSQL   │           │   │
│  │    │   (主从集群)   │           │   │
│  │    │               │           │   │
│  │    │ • 用户数据    │           │   │
│  │    │ • 大屏配置    │           │   │
│  │    │ • 组件数据    │           │   │
│  │    │ • 业务数据    │           │   │
│  │    └───────────────┘           │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         缓存加速层               │   │
│  │                                 │   │
│  │    ┌───────────────┐           │   │
│  │    │    Redis      │           │   │
│  │    │   (集群)      │           │   │
│  │    │               │           │   │
│  │    │ • Session     │           │   │
│  │    │ • 热点数据    │           │   │
│  │    │ • 实时数据    │           │   │
│  │    │ • 分布式锁    │           │   │
│  │    └───────────────┘           │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         扩展存储层               │   │
│  │                                 │   │
│  │  ┌─────────┐ ┌─────────┐      │   │
│  │  │ClickHouse│ │Elasticsearch│      │   │
│  │  │(时序数据)│ │  (搜索)  │      │   │
│  │  └─────────┘ └─────────┘      │   │
│  │                                 │   │
│  │  ┌─────────┐ ┌─────────┐      │   │
│  │  │  MinIO  │ │  Kafka  │      │   │
│  │  │(对象存储)│ │(消息队列)│      │   │
│  │  └─────────┘ └─────────┘      │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

## 3. 核心技术方案

### 3.1 前端架构

#### 3.1.1 状态管理

```
┌─────────────────────────────────────────┐
│            状态管理架构                   │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         全局状态 (Global)        │   │
│  │                                 │   │
│  │  ┌─────────┐  ┌─────────┐        │   │
│  │  │ User   │  │ App    │        │   │
│  │  │ Store  │  │ Store  │        │   │
│  │  │(用户)  │  │(应用)  │        │   │
│  │  └─────────┘  └─────────┘        │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │        模块状态 (Module)         │   │
│  │                                 │   │
│  │  ┌─────────┐  ┌─────────┐        │   │
│  │  │ Editor │  │ Screen │        │   │
│  │  │ Store  │  │ Store  │        │   │
│  │  │(编辑器) │  │(大屏)  │        │   │
│  │  └─────────┘  └─────────┘        │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │        组件状态 (Component)      │   │
│  │                                 │   │
│  │  • 表单状态                      │   │
│  │  • 组件内部数据                   │   │
│  │  • 临时计算属性                    │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

#### 3.1.2 组件架构

```
┌─────────────────────────────────────────┐
│            组件架构设计                   │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         页面层 (Pages)          │   │
│  │                                 │   │
│  │  • EditorPage   (编辑器页)      │   │
│  │  • PreviewPage  (预览页)       │   │
│  │  • AdminPage    (管理页)       │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         布局层 (Layouts)        │   │
│  │                                 │   │
│  │  • MainLayout   (主布局)        │   │
│  │  • BlankLayout  (空白布局)      │   │
│  │  • EditorLayout (编辑器布局)    │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         业务组件 (Business)      │   │
│  │                                 │   │
│  │  ┌─────────┐ ┌─────────┐       │   │
│  │  │Editor   │ │Screen   │       │   │
│  │  │Canvas   │ │Viewer   │       │   │
│  │  └─────────┘ └─────────┘       │   │
│  │                                 │   │
│  │  ┌─────────┐ ┌─────────┐       │   │
│  │  │Component│ │DataPanel│       │   │
│  │  │Library  │ │         │       │   │
│  │  └─────────┘ └─────────┘       │   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │         基础组件 (Base)          │   │
│  │                                 │   │
│  │  ┌─────────┐ ┌─────────┐       │